<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ค้นหาข้อมูลลูกค้า</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* Define CSS variables for easy theme customization */
        :root {
            --primary-color: #8A2BE2; /* A vibrant purple for accent */
            --secondary-color: #00BCD4; /* Cyan for secondary accent */
            --background-color: #1A1A2E; /* Deep dark blue-purple for main background */
            --card-background: #1F283E; /* Slightly lighter dark blue-purple for cards */
            --text-color: #E0E0E0; /* Light grey for general text */
            --light-text-color: #B0B0B0; /* Even lighter for secondary text */
            --border-color: #3A3A5A; /* Darker border for elements */
            --shadow-light: 0 6px 20px rgba(0, 0, 0, 0.4); /* Stronger shadow for dark mode */
            --success-bg: #28A745; /* Green for success messages */
            --success-text: #FFFFFF;
            --error-bg: #DC3545; /* Red for error messages */
            --error-text: #FFFFFF;
            --info-bg: #17A2B8; /* Blue for info messages */
            --info-text: #FFFFFF;
            --record-bg-odd: #2A3850; /* Background for odd records in dark mode */
            --record-bg-even: #1F283E; /* Background for even records in dark mode */
        }

        /* --- Light Mode Theme --- */
        body.light-mode {
            --primary-color: #8A2BE2;
            --secondary-color: #00BCD4;
            --background-color: #F4F6F8; /* Light grey background */
            --card-background: #FFFFFF; /* White cards */
            --text-color: #212529; /* Dark text */
            --light-text-color: #6c757d; /* Medium grey text */
            --border-color: #DEE2E6; /* Light grey border */
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1); /* Lighter shadow */
            --record-bg-odd: #FFFFFF;
            --record-bg-even: #F8F9FA;
        }
        body.light-mode .input-group input[type="text"] {
            background-color: #FFFFFF;
        }

        /* --- Theme Switch Styles --- */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
            width: 100%;
            padding: 10px 0;
        }
        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            flex-shrink: 0;
        }
        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4A5568; /* Dark grey for off state */
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: var(--light-text-color); /* Greyish knob */
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--secondary-color); /* Use secondary color for "on" */
        }
        input:checked + .slider:before {
            transform: translateX(22px);
            background-color: white;
        }
        .theme-switch-label {
            color: var(--text-color);
            font-size: 1em;
            font-weight: 500;
        }
        
        /* Basic styles for the body to center content and set font */
        body {
            font-family: 'Kanit', sans-serif; /* Use Kanit font */
            background-color: var(--background-color);
            min-height: 100vh; /* Ensure body takes full viewport height */
            margin: 0;
            color: var(--text-color);
            line-height: 1.6; /* Improve readability */
            box-sizing: border-box; /* Include padding in element's total width and height */
            background-image: url('/static/images/your_background_image.jpg'); /* Keep background image */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Dashboard Layout (New) */
        .dashboard-layout {
            display: flex;
            width: 100%;
            min-height: 100vh; /* Make dashboard take full screen height */
            background-color: rgba(0, 0, 0, 0.6); /* Semi-transparent overlay over background image */
            box-shadow: var(--shadow-light);
            overflow: hidden; /* For rounded corners */
            margin: 0;
        }

        /* Sidebar styles (New) */
        .sidebar {
            width: 250px;
            background-color: var(--card-background);
            padding: 30px 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            transition: width 0.3s ease-in-out;
            position: relative;
        }

        .sidebar-title {
            color: var(--primary-color);
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 40px;
            text-align: center;
        }

        /* Main content area (New) */
        .main-content-area {
            flex-grow: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 30px; /* Space between main-container and results-container */
            overflow-y: auto; /* Enable scrolling if content overflows */
            width: 100%;
        }

        /* Styles for the main container (search form) */
        .main-container {
            background-color: var(--card-background);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            text-align: center;
            width: 100%;
            max-width: none; /* Remove max-width here, handled by main-content-area */
            box-sizing: border-box;
            margin-bottom: 0; /* Managed by gap in main-content-area */
            margin-top: 0; /* Managed by gap in main-content-area */
        }

        /* Styles for the heading */
        .main-container h2 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 2.2em; /* Slightly larger heading */
        }

        /* Style for the logged-in user display */
        .logged-in-user {
            font-size: 1em; /* Slightly larger */
            color: var(--light-text-color);
            margin-bottom: 20px;
        }

        /* Flash messages styling */
        .flash-message {
            padding: 15px 20px; /* Larger padding */
            border-radius: 8px;
            margin-bottom: 25px; /* More space below */
            font-weight: 500;
            text-align: center;
            font-size: 1.05em;
        }
        .flash-message.success {
            background-color: var(--success-bg);
            color: var(--success-text);
            border: 1px solid var(--success-bg);
        }
        .flash-message.error {
            background-color: var(--error-bg);
            color: var(--error-text);
            border: 1px solid var(--error-bg);
        }
        .flash-message.info {
            background-color: var(--info-bg);
            color: var(--info-text);
            border: 1px solid var(--info-bg);
        }

        /* Styles for input groups (label + input) */
        .input-group {
            margin-bottom: 20px; /* More space between input groups */
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px; /* More space between label and input */
            font-weight: 400;
            color: var(--light-text-color); /* Lighter text for labels */
            font-size: 1em; /* Slightly larger font */
        }

        .input-group input[type="text"] {
            width: 100%;
            padding: 14px 18px; /* Larger padding */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.1em; /* Larger font size */
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            background-color: var(--background-color); /* Darker background for input */
            color: var(--text-color); /* Text color for input */
        }

        .input-group input[type="text"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(138, 43, 226, 0.3); /* Stronger shadow for focus */
            outline: none;
        }

        /* Styles for the search and clear buttons */
        .search-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px; /* More space above buttons */
            justify-content: center;
        }

        .search-button {
            background-color: var(--primary-color);
            color: white;
            padding: 16px 30px; /* Larger padding */
            border: none;
            border-radius: 8px;
            font-size: 1.2em; /* Larger font size */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            flex: 1;
            min-width: 150px; /* Wider min-width */
            font-weight: 600;
            letter-spacing: 0.5px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .search-button.clear {
            background-color: #FFC107; /* Orange for clear button */
            color: #333; /* Dark text for clear button */
        }

        .search-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .search-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .search-button.clear:hover {
            background-color: #e0a800;
        }

        /* Action button group (for sidebar) */
        .action-button-group {
            display: flex;
            flex-direction: column;
            gap: 15px; /* Space between buttons */
            width: 100%; /* Make buttons take full width of sidebar */
            margin-top: 0; /* Remove top margin, handled by sidebar padding */
        }

        /* Individual action button style (for sidebar) */
        .action-button {
            display: block; /* Make buttons take full width */
            padding: 15px 25px;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Darker shadow for dark mode */
            text-align: center;
        }

        .action-button:hover {
            background-color: #6A1B9A; /* Slightly darker purple on hover */
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        /* Active state for navigation buttons */
        .action-button.active {
            background-color: var(--secondary-color); /* Use secondary color for active state */
            color: var(--card-background); /* Dark text on active button */
            box-shadow: 0 4px 10px rgba(0, 189, 212, 0.4); /* Stronger shadow for active */
        }
        .action-button.active:hover {
            background-color: #008C9E; /* Darker secondary on hover for active */
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 189, 212, 0.5);
        }

        /* Logout button specific style (for sidebar) */
        .action-button.logout {
            background-color: var(--error-bg); /* Red for logout */
            margin-top: 40px; /* More space above logout */
        }

        .action-button.logout:hover {
            background-color: #B02A37; /* Darker red on hover */
        }


        /* Styles for search results container */
        .results-container {
            /* Inherits styles from .main-container for consistency */
            background-color: var(--card-background); /* Explicitly set for clarity */
            padding: 30px; /* Adjust padding for results */
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            width: 100%;
            max-width: none; /* Handled by main-content-area */
            box-sizing: border-box;
            margin-top: 0; /* Managed by gap in main-content-area */
            text-align: left;
        }

        .results-container h3 {
            color: var(--primary-color);
            margin-bottom: 25px; /* More space below heading */
            font-weight: 600;
            font-size: 1.8em; /* Larger heading */
            text-align: center;
        }

        /* Styles for individual customer records (cards) */
        .customer-record-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 25px; /* More padding */
            margin-bottom: 20px; /* More space between cards */
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15); /* Stronger shadow */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            background-color: var(--record-bg-even); /* Default to even for consistency */
        }
        .customer-record-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        /* Alternating background colors for records */
        .customer-record-card:nth-child(odd) {
            background-color: var(--record-bg-odd);
        }
        .customer-record-card:nth-child(even) {
            background-color: var(--record-bg-even);
        }

        .customer-record-card p {
            margin: 8px 0; /* More space between paragraphs */
            font-size: 1em; /* Slightly larger font */
            word-wrap: break-word; /* Ensure long links wrap */
            display: flex; /* Use flex for label-value alignment */
            align-items: baseline;
            gap: 10px; /* Space between strong and value */
        }
        .customer-record-card p strong {
            color: var(--secondary-color); /* Use secondary color for labels */
            min-width: 180px; /* Wider min-width for labels to align values */
            display: inline-block;
            flex-shrink: 0; /* Prevent label from shrinking */
        }
        .customer-record-card p a {
            color: var(--secondary-color); /* Link color */
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .customer-record-card p a:hover {
            text-decoration: underline;
            color: var(--primary-color);
        }

        /* Image thumbnails */
        .image-thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 12px; /* More space between thumbnails */
            margin-top: 15px; /* More space above */
            justify-content: flex-start;
        }
        .image-thumbnail {
            width: 90px; /* Slightly larger thumbnails */
            height: 90px;
            object-fit: cover;
            border: 2px solid var(--border-color); /* Thicker border */
            border-radius: 8px; /* More rounded */
            cursor: pointer;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .image-thumbnail:hover {
            transform: scale(1.08); /* More pronounced hover effect */
            border-color: var(--primary-color);
        }

        /* Lightbox/Modal Styles */
        .lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .lightbox-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .lightbox-content {
            position: relative;
            max-width: 95%; /* Allow more width */
            max-height: 95%; /* Allow more height */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .lightbox-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transform: scale(1); /* Initial zoom level */
            transition: transform 0.2s ease;
            border-radius: 8px; /* Rounded corners for image */
        }
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.6); /* Darker nav background */
            color: white;
            padding: 12px 18px; /* Larger padding */
            cursor: pointer;
            border-radius: 8px; /* More rounded */
            font-size: 1.8em; /* Larger font size */
            user-select: none;
            transition: background-color 0.2s ease;
        }
        .lightbox-nav:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .lightbox-nav.prev { left: 20px; } /* More distance from edge */
        .lightbox-nav.next { right: 20px; }
        .lightbox-close {
            position: absolute;
            top: 20px; /* More distance from top */
            right: 20px; /* More distance from right */
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 50%; /* Changed to circle */
            width: 40px; /* Make it a clear circle */
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em; /* Larger font size */
            user-select: none;
            transition: background-color 0.2s ease;
        }
        .lightbox-close:hover {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .lightbox-zoom-controls {
            position: absolute;
            bottom: 20px; /* More distance from bottom */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            display: flex;
            gap: 15px; /* More space between buttons */
        }
        .lightbox-zoom-controls button {
            background: none;
            border: none;
            color: white;
            font-size: 1.5em; /* Larger font size */
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .lightbox-zoom-controls button:hover {
            color: var(--primary-color); /* Highlight on hover */
        }

        .record-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 12px; /* More space between buttons */
            margin-top: 20px; /* More space above buttons */
            justify-content: flex-end; /* Align buttons to the right */
        }

        /* NEW: Specific style for the new update status button */
        .record-button.update-status-btn {
            background-color: var(--secondary-color);
            color: white;
            padding: 5px 8px; /* Smaller padding */
            font-size: 0.8em;
            line-height: 1;
            border-radius: 50%; /* Make it a circle */
        }

        .record-button {
            background-color: var(--secondary-color);
            color: var(--card-background); /* Dark text for light button */
            padding: 10px 20px; /* Larger padding */
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        .record-button.edit {
            background-color: var(--primary-color);
            color: white;
        }
        .record-button:hover {
            transform: translateY(-2px);
            opacity: 0.95;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
        }
        .record-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
        }
        .record-button.contacted {
            background-color: #28a745; /* Green */
            color: white;
        }
        .record-button.contacted:hover {
            background-color: #218838;
        }
        .record-button.not-interested {
            background-color: #6c757d; /* Grey */
            color: white;
        }
        .record-button.not-interested:hover {
            background-color: #5a6268;
        }
        .record-button.schedule-inspection-btn {
            background-color: #007bff; /* Blue */
            color: white;
        }
        .record-button.schedule-inspection-btn:hover {
            background-color: #0056b3;
        }
        .record-button.statement-failed-btn {
            background-color: #dc3545; /* Red */
            color: white;
        }
        .record-button.statement-failed-btn:hover {
            background-color: #c82333;
        }
        .record-button.reschedule-inspection-btn {
            background-color: #ffc107; /* Orange */
            color: #333;
        }
        .record-button.approve-btn {
            background-color: #28a745; /* Green */
            color: white;
        }
        .record-button.approve-btn:hover {
            background-color: #218838;
        }
        .record-button.inspection-failed-btn {
            background-color: #dc3545; /* Red */
            color: white;
        }
        .record-button.inspection-failed-btn:hover {
            background-color: #c82333;
        }

        /* NEW: Table and Pagination Styles */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.85em; /* ลดขนาดฟอนต์เล็กน้อยเพื่อประหยัดพื้นที่ */
            /* ลบ min-width เพื่อให้ตารางปรับขนาดตามหน้าจอได้ */
        }

        .results-table th, .results-table td {
            border: 1px solid var(--border-color);
            padding: 8px 10px; /* ลด padding ในเซลล์ */
            text-align: left;
            vertical-align: middle;
            white-space: normal; /* อนุญาตให้ข้อความขึ้นบรรทัดใหม่เป็นค่าเริ่มต้น */
            word-break: break-word; /* ตัดคำยาวๆ เพื่อไม่ให้ล้นเซลล์ */
        }

        .results-table th {
            background-color: var(--record-bg-odd);
            color: var(--primary-color);
            font-weight: 600;
        }

        .results-table tbody tr:nth-child(odd) {
            background-color: var(--record-bg-odd);
        }

        .results-table tbody tr:nth-child(even) {
            background-color: var(--record-bg-even);
        }

        .results-table tbody tr:hover {
            background-color: rgba(138, 43, 226, 0.15);
        }

        /* NEW: Styles for status cell layout */
        .status-cell-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge {
            padding: 3px 8px;
            border-radius: 15px;
            color: white;
            font-weight: 500;
            font-size: 0.8em;
            text-align: center;
            display: inline-block;
            white-space: nowrap;
        }
        .status-pending { background-color: #FFC107; color: #333; } /* Yellow */
        .status-approved { background-color: #28A745; } /* Green */
        .status-rejected { background-color: #DC3545; } /* Red */
        .status-cancelled { background-color: #b2b2b2; } /* Grey */
        .status-unknown { background-color: #ae008e; } /* Grey */
        .status-inspection-needed { background-color: #fd7e14; } /* Orange for inspection */
        .status-contact-needed { background-color: #17A2B8; } /* Blue/Info color */

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 8px;
            flex-wrap: wrap;
        }
        .pagination-controls a, .pagination-controls span {
            color: var(--text-color);
            padding: 8px 15px;
            text-decoration: none;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            transition: background-color 0.3s, color 0.3s;
        }
        .pagination-controls a:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .pagination-controls .current-page {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: bold;
            cursor: default;
        }
        .pagination-controls .disabled {
            color: var(--light-text-color);
            pointer-events: none;
            background-color: transparent;
            border-color: var(--border-color);
        }

        /* NEW: จัดการการตัดคำและความกว้างของแต่ละคอลัมน์ */
        /* คอลัมน์ที่ไม่ต้องการให้ตัดคำขึ้นบรรทัดใหม่ */
        .results-table th:nth-child(1), .results-table td:nth-child(1),   /* รหัสลูกค้า */
        .results-table th:nth-child(3), .results-table td:nth-child(3),   /* เบอร์มือถือ */
        .results-table th:nth-child(5), .results-table td:nth-child(5),   /* จังหวัด */
        .results-table th:nth-child(6), .results-table td:nth-child(6),   /* วงเงิน */
        .results-table th:nth-child(7), .results-table td:nth-child(7),   /* ดอกเบี้ย */
        .results-table th:nth-child(8), .results-table td:nth-child(8),   /* วันที่ขอเข้ามา */
        .results-table th:nth-child(11), .results-table td:nth-child(11), /* วันที่นัดตรวจ */
        .results-table th:nth-child(12), .results-table td:nth-child(12), /* เวลานัดตรวจ */
        .results-table th:nth-child(14), .results-table td:nth-child(14), /* สถานะ */
        .results-table th:nth-child(16), .results-table td:nth-child(16)  /* การกระทำ */
        {
            white-space: nowrap;
        }

        /* กำหนดความกว้างขั้นต่ำให้คอลัมน์ที่ตัดคำได้ เพื่อไม่ให้แคบเกินไป */
        .results-table th:nth-child(2), .results-table td:nth-child(2),   /* ชื่อ-นามสกุล */
        .results-table th:nth-child(4), .results-table td:nth-child(4),   /* ชื่อกิจการ */
        .results-table th:nth-child(9), .results-table td:nth-child(9),   /* บริษัทที่รับงาน */
        .results-table th:nth-child(10), .results-table td:nth-child(10), /* ขอเข้ามาทางไหน */
        .results-table th:nth-child(13), .results-table td:nth-child(13), /* ผู้รับงานตรวจ */
        .results-table th:nth-child(15), .results-table td:nth-child(15)  /* ผู้บันทึก */
        {
            min-width: 120px;
        }

        /* ให้พื้นที่คอลัมน์ 'ชื่อกิจการ' มากเป็นพิเศษ */
        .results-table th:nth-child(4), .results-table td:nth-child(4) {
            min-width: 180px;
        }

        /* NEW: Modal Styles for Customer Details */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            display: flex;
            opacity: 1;
        }
        .modal-content {
            background-color: var(--card-background);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: var(--shadow-light);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: var(--light-text-color);
            font-size: 2.5rem;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .modal-close:hover {
            color: var(--text-color);
        }
        #modal-body h3 {
            color: var(--primary-color);
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }
        .detail-list { /* Changed from detail-grid */
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .detail-item {
            display: flex;
            align-items: baseline;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.05em;
        }
        .detail-item:last-child {
            border-bottom: none;
        }
        .detail-label {
            font-weight: 600;
            color: var(--secondary-color);
            flex-shrink: 0;
            width: 200px;
        }
        .detail-value {
            word-break: break-word;
        }
        .detail-value a {
            color: var(--secondary-color);
            text-decoration: none;
        }
        .detail-value a:hover {
            text-decoration: underline;
        }
        .modal-actions {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        .modal-content .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            background-color: #2D3A50;
            color: var(--text-color);
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.light-mode .modal-content .form-control {
            background-color: #FFFFFF;
        }
        .modal-content .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.3);
            outline: none;
        }
        #inspectionModal h3 {
            color: var(--primary-color);
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.8em;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }

        /* --- NEW: Collapsible Sidebar & Full-width Layout Styles --- */
        .sidebar-toggle-btn {
            position: absolute;
            top: 25px;
            right: -15px;
            width: 30px;
            height: 30px;
            background-color: var(--primary-color);
            color: white;
            border: 1px solid var(--background-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        .sidebar-toggle-btn:hover {
            background-color: #6A1B9A;
            transform: scale(1.1);
        }
        .sidebar-toggle-btn i {
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            width: 85px;
        }
        .sidebar.collapsed .sidebar-toggle-btn i {
            transform: rotate(180deg);
        }
        .sidebar.collapsed .sidebar-title,
        .sidebar.collapsed .link-text,
        .sidebar.collapsed .theme-switch-label,
        .sidebar.collapsed .logged-in-user {
            opacity: 0;
            width: 0;
            height: 0;
            overflow: hidden;
            pointer-events: none;
            margin: 0;
            padding: 0;
            white-space: nowrap;
        }
        .sidebar.collapsed .action-button {
            justify-content: center;
        }
        .sidebar.collapsed .action-button i {
            margin-right: 0;
            font-size: 1.4em;
        }
        .sidebar.collapsed .theme-switch-wrapper {
            justify-content: center;
        }
        .action-button i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        /* Back to Main Menu button at the bottom (Removed, replaced by sidebar) */
        /* .back-to-main-menu { ... } */

        /* Responsive adjustments */
        @media (max-width: 992px) { /* Adjust for smaller screens (tablets) */
            .dashboard-layout {
                flex-direction: column;
                min-height: unset; /* Allow height to adjust */
                max-width: 90%;
            }
            .sidebar {
                width: 100%;
                padding: 20px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
            }
            .main-content-area {
                padding: 20px;
            }
            .main-container, .results-container {
                padding: 30px;
                margin-top: 0; /* Handled by main-content-area gap */
                margin-bottom: 0; /* Handled by main-content-area gap */
            }
            .action-button-group {
                flex-direction: row; /* Buttons in a row on smaller screens */
                flex-wrap: wrap;
                justify-content: center;
            }
            .action-button {
                flex-basis: 48%; /* Two buttons per row */
            }
            .action-button.logout {
                margin-top: 15px;
                flex-basis: 98%; /* Logout button takes full width */
            }
            .sidebar-title {
                margin-bottom: 20px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 0; /* Remove body padding, dashboard-layout handles margin */
            }
            .main-container, .results-container {
                padding: 25px;
            }
            .main-container h2 {
                font-size: 1.8em;
            }
            .input-group label {
                font-size: 0.9em;
            }
            .input-group input[type="text"] {
                padding: 12px 15px;
                font-size: 1em;
            }
            .search-button {
                padding: 12px 20px;
                font-size: 1em;
                width: 100%; /* Full width on small screens */
                min-width: unset; /* Remove min-width for full width */
            }
            .search-button-group, .record-buttons {
                flex-direction: column;
                gap: 10px;
            }
            .customer-record-card {
                padding: 18px;
                margin-bottom: 15px;
            }
            .customer-record-card p {
                font-size: 0.9em;
                flex-direction: column; /* Stack label and value on small screens */
                align-items: flex-start;
                gap: 3px;
            }
            .customer-record-card p strong {
                min-width: unset;
                margin-bottom: 3px;
                font-size: 0.95em; /* Slightly smaller for mobile labels */
            }
            .image-thumbnails {
                gap: 8px;
                justify-content: center; /* Center thumbnails on mobile */
            }
            .image-thumbnail {
                width: 70px;
                height: 70px;
                border-width: 1px;
            }
            .lightbox-nav {
                font-size: 1.5em;
                padding: 10px 15px;
                left: 10px;
                right: 10px;
            }
            .lightbox-close {
                font-size: 1.2em;
                width: 35px;
                height: 35px;
                top: 10px;
                right: 10px;
            }
            .lightbox-zoom-controls {
                font-size: 1.2em;
                padding: 5px 10px;
                bottom: 10px;
            }
            .record-button {
                padding: 8px 15px;
                font-size: 0.9em;
                width: 100%;
            }
            /* Remove back-to-main-menu button's specific mobile styles as it's removed */
            /* .back-to-main-menu { ... } */
        }
    </style>
    <meta name="viewport" content="width=1200">
</head>
<body>
    <div class="dashboard-layout">
        <div class="sidebar">
            <h3 class="sidebar-title">เมนู</h3>
            <div class="action-button-group">
                <a href="{{ url_for('dashboard') }}" class="action-button {% if request.endpoint == 'dashboard' %}active{% endif %}"><i class="fas fa-home"></i><span class="link-text">หน้าหลัก</span></a>
                <a href="{{ url_for('enter_customer_data') }}" class="action-button {% if request.endpoint == 'enter_customer_data' %}active{% endif %}"><i class="fas fa-user-plus"></i><span class="link-text">กรอกข้อมูลลูกค้าใหม่</span></a>
                <a href="{{ url_for('search_customer_data') }}" class="action-button {% if request.endpoint == 'search_customer_data' %}active{% endif %}"><i class="fas fa-search"></i><span class="link-text">ค้นหาข้อมูลลูกค้า</span></a>
                <a href="{{ url_for('loan_management') }}" class="action-button {% if request.endpoint == 'loan_management' %}active{% endif %}"><i class="fas fa-hand-holding-usd"></i><span class="link-text">จัดการสินเชื่อ</span></a>
                <div class="theme-switch-wrapper">
                    <label class="theme-switch" for="theme-checkbox">
                        <input type="checkbox" id="theme-checkbox" />
                        <div class="slider round"></div>
                    </label>
                    <span class="theme-switch-label link-text">โหมดมืด</span>
                </div>
                <a href="{{ url_for('logout') }}" class="action-button logout"><i class="fas fa-sign-out-alt"></i><span class="link-text">ออกจากระบบ</span></a>
            </div>
            <p class="logged-in-user" style="margin-top: 25px; text-align: center;">สวัสดี, {{ username }}</p>
        </div>
        <div class="main-content-area">
            <div class="main-container">
                <h2>ค้นหาข้อมูลลูกค้า</h2>
                <p class="logged-in-user">เข้าสู่ระบบโดย: {{ username }}</p>

                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="flash-message {{ category }}">{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                <form method="GET" action="{{ url_for('search_customer_data') }}" class="search-form">
                    <div class="input-group">
                        <label for="search_keyword">คำค้นหา (รหัสลูกค้า, ชื่อ, นามสกุล, เบอร์มือถือ, เลขบัตรประชาชน, ชื่อกิจการ)</label>
                        <input type="text" id="search_keyword" name="search_keyword" placeholder="กรอกคำค้นหา" value="{{ search_keyword if search_keyword else '' }}">
                    </div>
                    
                    <div class="search-button-group">
                        <button type="submit" class="search-button">ค้นหาข้อมูล</button>
                        <button type="button" class="search-button clear" id="clearSearchButton">ล้างข้อมูลการค้นหา</button>
                    </div>
                </form>
            </div>

            <div class="results-container">
                <h3>{{ display_title }}</h3>

                {% if customer_records %}
                <div class="table-responsive">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>รหัสลูกค้า</th>
                                <th>ชื่อ-นามสกุล</th>
                                <th>เบอร์มือถือ</th>
                                <th>ชื่อกิจการ</th>
                                <th>จังหวัด</th>
                                <th>วงเงินที่ต้องการ</th>
                                <th>ดอกเบี้ย</th>
                                <th>วันที่ขอเข้ามา</th>
                                <th>บริษัทที่รับงาน</th>
                                <th>ขอเข้ามาทางไหน</th>
                                <th>วันที่นัดตรวจ</th>
                                <th>เวลานัดตรวจ</th>
                                <th>ผู้รับงานตรวจ</th>
                                <th>สถานะ</th>
                                <th>ผู้บันทึก</th>
                                <th>การกระทำ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in customer_records %}
                            <tr>
                                <td>{{ record.get('Customer ID', '-') }}</td>
                                <td>{{ record.get('ชื่อ', '') }} {{ record.get('นามสกุล', '') }}</td>
                                <td>{{ record.get('เบอร์มือถือ', '-') }}</td>
                                <td>{{ record.get('ชื่อกิจการ', '-') }}</td>
                                <td>{{ record.get('จังหวัดที่อยู่', '-') }}</td>
                                <td>{{ record.get('วงเงินที่ต้องการ', '-') }}</td>
                                <td>{{ record.get('หักดอกหัวท้าย', '-') }}</td>
                                <td>{{ record.get('วันที่ขอเข้ามา', '-') }}</td>
                                <td>{{ record.get('บริษัทที่รับงาน', '-') }}</td>
                                <td>{{ record.get('ขอเข้ามาทางไหน', '-') }}</td>
                                <td>{{ record.get('วันที่นัดตรวจ', '-') }}</td>
                                <td>{{ record.get('เวลานัดตรวจ', '-') }}</td>
                                <td>{{ record.get('ผู้รับงานตรวจ', '-') }}</td>
                                <td id="status-cell-{{ record.row_index }}">
                                    <div class="status-cell-content">
                                        {% set status = record.get('สถานะ', 'unknown') | string | lower %}
                                        {% if 'รอติดต่อ' in status %}<span class="status-badge status-contact-needed">รอติดต่อ</span>
                                        {% elif 'รอดำเนินการ' in status %}<span class="status-badge status-pending">รอดำเนินการ</span>
                                        {% elif 'รอตรวจ' in status %}<span class="status-badge status-inspection-needed">รอตรวจ</span>
                                        {% elif 'ไม่อนุมัติ' in status %}<span class="status-badge status-rejected">ไม่อนุมัติ</span>
                                        {% elif 'อนุมัติ' in status %}<span class="status-badge status-approved">อนุมัติ</span>
                                        {% elif 'ยกเลิก' in status %}<span class="status-badge status-cancelled">ยกเลิก</span>
                                        {% else %}<span class="status-badge status-unknown">{{ record.get('สถานะ', 'N/A') }}</span>
                                        {% endif %}
                                        <button type="button" class="record-button update-status-btn" 
                                                data-row-index="{{ record.row_index }}" 
                                                data-current-status="{{ record.get('สถานะ') }}"
                                                data-record='{{ record | tojson | safe }}'>
                                            <i class="fas fa-pen"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>{{ record.get('Logged In User', '-') }}</td>
                                <td id="action-cell-{{ record.row_index }}">
                                    <button type="button" class="record-button view-details-btn" data-record='{{ record | tojson | safe }}'>ดูข้อมูล</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {# Pagination Controls #}
                {% if pagination and pagination.total_pages > 1 %}
                <div class="pagination-controls">
                    {# Previous Page Link #}
                    {% if pagination.has_prev %}
                        <a href="{{ url_for('search_customer_data', page=pagination.prev_num, search_keyword=search_keyword) }}">&laquo; ก่อนหน้า</a>
                    {% else %}
                        <span class="disabled">&laquo; ก่อนหน้า</span>
                    {% endif %}

                    {# Page Numbers #}
                    {% for page_num in range(1, pagination.total_pages + 1) %}
                        {% if page_num == pagination.page %}
                            <span class="current-page">{{ page_num }}</span>
                        {% else %}
                            <a href="{{ url_for('search_customer_data', page=page_num, search_keyword=search_keyword) }}">{{ page_num }}</a>
                        {% endif %}
                    {% endfor %}

                    {# Next Page Link #}
                    {% if pagination.has_next %}
                        <a href="{{ url_for('search_customer_data', page=pagination.next_num, search_keyword=search_keyword) }}">ถัดไป &raquo;</a>
                    {% else %}
                        <span class="disabled">ถัดไป &raquo;</span>
                    {% endif %}
                </div>
                {% endif %}

                {% else %}
                    {# This part is shown if no records are found after a search, handled by flash message now, but good to have a fallback #}
                    <p style="text-align: center; color: var(--light-text-color); margin-top: 20px;">ไม่พบข้อมูลที่ตรงกับเงื่อนไข</p>
                {% endif %}
            </div>

            {# Removed the old back-to-main-menu button as sidebar handles navigation #}
            <!-- <a href="{{ url_for('dashboard') }}" class="back-to-main-menu">กลับสู่เมนูหลัก</a> -->

        </div>
    </div>
    
    <!-- NEW: Details Modal -->
    <div id="detailsModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="modalCloseBtn">&times;</span>
            <div id="modal-body">
                <!-- Customer details will be injected here by JS -->
            </div>
        </div>
    </div>

    <!-- NEW: Inspection Scheduling Modal -->
    <div id="inspectionModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="inspectionModalCloseBtn">&times;</span>
            <form id="inspectionForm">
                <h3 id="inspectionModalTitle">นัดตรวจกิจการ</h3>
                <input type="hidden" id="inspectionRowIndex" name="row_index">
                <div class="input-group">
                    <label for="inspection_date">วันที่นัดตรวจ</label>
                    <input type="date" id="inspection_date" name="inspection_date" class="form-control" required>
                </div>
                <div class="input-group">
                    <label for="inspection_time">เวลานัดตรวจ</label>
                    <input type="time" id="inspection_time" name="inspection_time" class="form-control" required>
                </div>
                <div class="input-group">
                    <label for="inspector">ผู้รับงานตรวจ</label>
                    <input type="text" id="inspector" name="inspector" class="form-control" placeholder="กรอกชื่อผู้ตรวจ" required>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="record-button schedule-inspection-btn">บันทึกการนัดหมาย</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Universal Update Status Modal -->
    <div id="updateStatusModal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" id="updateStatusModalCloseBtn">&times;</span>
            <form id="updateStatusForm">
                <h3 id="updateStatusModalTitle">อัปเดตสถานะ</h3>
                <input type="hidden" id="updateStatusRowIndex" name="row_index">
                
                <div class="input-group">
                    <label>สถานะปัจจุบัน</label>
                    <input type="text" id="currentStatusDisplay" class="form-control" readonly>
                </div>

                <div class="input-group">
                    <label for="updateStatusSelect">เปลี่ยนสถานะเป็น</label>
                    <select id="updateStatusSelect" name="new_status" class="form-control" required></select>
                </div>

                <div id="noteInputGroup" class="input-group" style="display: none;">
                    <label for="status_note">เหตุผล/หมายเหตุ (จำเป็น)</label>
                    <textarea id="status_note" name="note" class="form-control" rows="3"></textarea>
                </div>

                <div id="inspectionInputGroup" style="display: none;">
                    <div class="input-group"><label for="status_inspection_date">วันที่นัดตรวจ</label><input type="date" id="status_inspection_date" name="inspection_date" class="form-control"></div>
                    <div class="input-group"><label for="status_inspection_time">เวลานัดตรวจ</label><input type="time" id="status_inspection_time" name="inspection_time" class="form-control"></div>
                    <div class="input-group"><label for="status_inspector">ผู้รับงานตรวจ</label><input type="text" id="status_inspector" name="inspector" class="form-control" placeholder="กรอกชื่อผู้ตรวจ"></div>
                </div>

                <div class="modal-actions"><button type="submit" class="record-button approve-btn">ยืนยันการอัปเดต</button></div>
            </form>
        </div>
    </div>

    <div class="lightbox-overlay" id="lightboxOverlay">
        <div class="lightbox-content">
            <img src="" alt="Full size image" class="lightbox-image" id="lightboxImage" onerror="console.error('Lightbox image load error. src:', this.src, '. Please check Cloudinary URL and permissions.'); this.src='https://placehold.co/600x400/FF0000/FFFFFF?text=Error';">
            <span class="lightbox-nav prev" id="lightboxPrev">&lt;</span>
            <span class="lightbox-nav next" id="lightboxNext">&gt;</span>
            <span class="lightbox-close" id="lightboxClose">X</span>
            <div class="lightbox-zoom-controls">
                <button id="zoomInButton">+</button>
                <button id="zoomOutButton">-</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggleCheckbox = document.getElementById('theme-checkbox');
            const body = document.body;
            const themeLabel = document.querySelector('.theme-switch-label');

            // Function to apply the theme
            const applyTheme = (theme) => {
                if (theme === 'light') {
                    body.classList.add('light-mode');
                    if (themeToggleCheckbox) themeToggleCheckbox.checked = true;
                    if (themeLabel) themeLabel.textContent = 'โหมดสว่าง';
                } else {
                    body.classList.remove('light-mode');
                    if (themeToggleCheckbox) themeToggleCheckbox.checked = false;
                    if (themeLabel) themeLabel.textContent = 'โหมดมืด';
                }
            };

            // Load saved theme from localStorage, default to 'dark'
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            // Add event listener to the button
            if (themeToggleCheckbox) {
                themeToggleCheckbox.addEventListener('change', () => {
                    const newTheme = themeToggleCheckbox.checked ? 'light' : 'dark';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            }
        });
        document.addEventListener('DOMContentLoaded', function() {
            const clearSearchButton = document.getElementById('clearSearchButton');
            const searchForm = document.querySelector('.search-form');
            const searchKeywordInput = document.getElementById('search_keyword');

            // --- NEW: Details Modal ---
            const detailsModal = document.getElementById('detailsModal');
            const modalBody = document.getElementById('modal-body');
            const modalCloseBtn = document.getElementById('modalCloseBtn');
            const resultsTableBody = document.querySelector('.results-table tbody');

            // --- NEW: Universal Status Update Modal ---
            const updateStatusModal = document.getElementById('updateStatusModal');
            const updateStatusForm = document.getElementById('updateStatusForm');
            const updateStatusModalCloseBtn = document.getElementById('updateStatusModalCloseBtn');
            const updateStatusSelect = document.getElementById('updateStatusSelect');

            if (clearSearchButton) {
                clearSearchButton.addEventListener('click', function() {
                    searchKeywordInput.value = '';
                    searchForm.submit(); // Submit with empty keyword to clear results
                });
            }

            // --- Lightbox Logic (for image thumbnails in modal) ---
            const lightboxOverlay = document.getElementById('lightboxOverlay');
            const lightboxImage = document.getElementById('lightboxImage');
            const lightboxPrev = document.getElementById('lightboxPrev');
            const lightboxNext = document.getElementById('lightboxNext');
            const lightboxClose = document.getElementById('lightboxClose');
            const zoomInButton = document.getElementById('zoomInButton');
            const zoomOutButton = document.getElementById('zoomOutButton');

            let currentImageUrls = [];
            let currentImageIndex = 0;
            let currentZoom = 1;

            function openLightbox(urls, startIndex) {
                currentImageUrls = urls;
                currentImageIndex = startIndex;
                currentZoom = 1; // Reset zoom when opening new image
                updateLightboxImage();
                lightboxOverlay.classList.add('visible');
            }

            function updateLightboxImage() {
                if (currentImageUrls.length > 0) {
                    lightboxImage.src = currentImageUrls[currentImageIndex];
                    lightboxImage.style.transform = `scale(${currentZoom})`; // Apply zoom
                    lightboxPrev.style.display = currentImageUrls.length > 1 ? 'block' : 'none';
                    lightboxNext.style.display = currentImageUrls.length > 1 ? 'block' : 'none';
                }
            }

            function closeLightbox() {
                lightboxOverlay.classList.remove('visible');
                lightboxImage.src = ''; // Clear image source
            }

            // --- NEW: Details Modal Logic ---
            if (resultsTableBody) {
                resultsTableBody.addEventListener('click', function(event) {
                    const viewBtn = event.target.closest('.view-details-btn');
                    if (viewBtn) {
                        const recordData = JSON.parse(viewBtn.dataset.record);
                        populateModal(recordData);
                        detailsModal.classList.add('visible');
                    }
                });
            }

            function populateModal(record) {
                const createDetailItem = (label, value, isLink = false) => {
                    const displayValue = (value && String(value).trim() !== '' && String(value).trim() !== '-') ? value : '-';
                    let valueHTML = (isLink && displayValue !== '-') ? `<a href="${displayValue}" target="_blank" rel="noopener noreferrer">${displayValue}</a>` : displayValue;
                    return `<div class="detail-item"><strong class="detail-label">${label}:</strong> <span class="detail-value">${valueHTML}</span></div>`;
                };

                let imagesHTML = '';
                const imageUrls = (record['Image URLs'] || '').split(',').map(url => url.trim()).filter(url => url && url !== '-');
                if (imageUrls.length > 0) {
                    imagesHTML += '<div class="detail-item"><strong class="detail-label">รูปภาพ:</strong><div class="image-thumbnails">';
                    imageUrls.forEach(url => {
                        imagesHTML += `<img src="${url}" alt="Thumbnail" class="image-thumbnail" onerror="this.src='https://placehold.co/90x90/FF0000/FFFFFF?text=Error';">`;
                    });
                    imagesHTML += '</div></div>'; // Close image-thumbnails and detail-item
                } else {
                    imagesHTML = createDetailItem('รูปภาพ', '-');
                }

                modalBody.innerHTML = `
                    <h3>รายละเอียดลูกค้า: ${record['ชื่อ'] || ''} ${record['นามสกุล'] || ''}</h3>
                    <div class="detail-list">
                        ${createDetailItem('รหัสลูกค้า', record['Customer ID'])}
                        ${createDetailItem('ชื่อ-นามสกุล', `${record['ชื่อ'] || ''} ${record['นามสกุล'] || ''}`)}
                        ${createDetailItem('เบอร์มือถือ', record['เบอร์มือถือ'])}
                        ${createDetailItem('เลขบัตรประชาชน', record['เลขบัตรประชาชน'])}
                        ${createDetailItem('บริษัทที่รับงาน', record['บริษัทที่รับงาน'])}
                        ${createDetailItem('กลุ่มลูกค้าหลัก', record['กลุ่มลูกค้าหลัก'])}
                        ${createDetailItem('กลุ่มอาชีพย่อย', record['กลุ่มอาชีพย่อย'])}
                        ${createDetailItem('จดทะเบียน', record['จดทะเบียน'])}
                        ${createDetailItem('ชื่อกิจการ', record['ชื่อกิจการ'])}
                        ${createDetailItem('จังหวัดที่อยู่', record['จังหวัดที่อยู่'])}
                        ${createDetailItem('ที่อยู่จดทะเบียน', record['ที่อยู่จดทะเบียน'])}
                        ${createDetailItem('สถานะ', record['สถานะ'])}
                        ${createDetailItem('วงเงินที่ต้องการ', record['วงเงินที่ต้องการ'])}
                        ${createDetailItem('วงเงินที่อนุมัติ', record['วงเงินที่อนุมัติ'])}
                        ${createDetailItem('เคยขอเข้ามาในเครือหรือยัง', record['เคยขอเข้ามาในเครือหรือยัง'])}
                        ${createDetailItem('เช็ค', record['เช็ค'])}
                        ${createDetailItem('ขอเข้ามาทางไหน', record['ขอเข้ามาทางไหน'])}
                        ${createDetailItem('หักดอกหัวท้าย', record['หักดอกหัวท้าย'])}
                        ${createDetailItem('ค่าดำเนินการ', record['ค่าดำเนินการ'])}
                        ${createDetailItem('วันที่ขอเข้ามา', record['วันที่ขอเข้ามา'])}
                        ${createDetailItem('วันที่นัดตรวจ', record['วันที่นัดตรวจ'])}
                        ${createDetailItem('เวลานัดตรวจ', record['เวลานัดตรวจ'])}
                        ${createDetailItem('ผู้รับงานตรวจ', record['ผู้รับงานตรวจ'])}
                        ${createDetailItem('ลิงค์โลเคชั่นบ้าน', record['ลิงค์โลเคชั่นบ้าน'], true)}
                        ${createDetailItem('ลิงค์โลเคชั่นที่ทำงาน', record['ลิงค์โลเคชั่นที่ทำงาน'], true)}
                        ${createDetailItem('หมายเหตุ', record['หมายเหตุ'])}
                        ${createDetailItem('บันทึกโดย', record['Logged In User'])}
                        ${imagesHTML}
                    </div>
                    <div class="modal-actions">
                        <a href="/edit_customer_data/${record.row_index}" class="record-button edit">แก้ไขข้อมูล</a>
                    </div>
                `;

                // Add event listeners for new thumbnails inside the modal
                const thumbnailContainer = modalBody.querySelector('.image-thumbnails');
                if (thumbnailContainer) {
                    thumbnailContainer.querySelectorAll('.image-thumbnail').forEach((thumbnail, index) => {
                        thumbnail.addEventListener('click', () => {
                            openLightbox(imageUrls, index);
                        });
                    });
                }
            }

            if (modalCloseBtn) {
                modalCloseBtn.addEventListener('click', () => {
                    detailsModal.classList.remove('visible');
                });
            }

            if (detailsModal) {
                detailsModal.addEventListener('click', (event) => {
                    if (event.target === detailsModal) {
                        detailsModal.classList.remove('visible');
                    }
                });
            }

            // --- REFACTORED: Central Event Listener for Action Buttons ---
            const resultsContainer = document.querySelector('.results-container');
            if (resultsContainer) {
                resultsContainer.addEventListener('click', async function(event) {
                    const updateBtn = event.target.closest('.update-status-btn');

                    if (updateBtn) {
                        const rowIndex = updateBtn.dataset.rowIndex;
                        const currentStatus = updateBtn.dataset.currentStatus;
                        const record = JSON.parse(updateBtn.dataset.record);
                        if (!rowIndex) return;

                        // Define the possible next statuses for each current status
                        const nextStatusMap = {
                            'รอติดต่อ': ['รอดำเนินการ', 'ยกเลิก'],
                            'รอดำเนินการ': ['รอตรวจ', 'ไม่อนุมัติ'],
                            'รอตรวจ': ['อนุมัติ', 'ไม่อนุมัติ', 'เลื่อนนัด']
                        };

                        const availableOptions = nextStatusMap[currentStatus] || [];

                        if (availableOptions.length === 0) {
                            alert(`สถานะ "${currentStatus}" ไม่สามารถเปลี่ยนแปลงได้ในหน้านี้`);
                            return;
                        }

                        // Populate and show the modal
                        updateStatusForm.reset();
                        document.getElementById('updateStatusRowIndex').value = rowIndex;
                        document.getElementById('currentStatusDisplay').value = currentStatus;

                        updateStatusSelect.innerHTML = '<option value="">-- เลือกสถานะใหม่ --</option>';
                        availableOptions.forEach(option => {
                            updateStatusSelect.innerHTML += `<option value="${option}">${option}</option>`;
                        });

                        // Pre-fill data for "เลื่อนนัด"
                        if (currentStatus === 'รอตรวจ') {
                            document.getElementById('status_inspection_date').value = record['วันที่นัดตรวจ'] || '';
                            document.getElementById('status_inspection_time').value = record['เวลานัดตรวจ'] || '';
                            document.getElementById('status_inspector').value = record['ผู้รับงานตรวจ'] || '';
                        }

                        // Trigger change event to set initial visibility of extra fields
                        updateStatusSelect.dispatchEvent(new Event('change'));

                        updateStatusModal.classList.add('visible');
                    }

                });
            }

            // --- NEW: Logic for the Universal Status Update Modal ---
            if (updateStatusModal) {
                const closeUpdateModal = () => updateStatusModal.classList.remove('visible');
                updateStatusModalCloseBtn.addEventListener('click', closeUpdateModal);
                updateStatusModal.addEventListener('click', (e) => {
                    if (e.target === updateStatusModal) closeUpdateModal();
                });

                // Show/hide extra fields based on selection
                updateStatusSelect.addEventListener('change', function() {
                    const selectedStatus = this.value;
                    const noteGroup = document.getElementById('noteInputGroup');
                    const inspectionGroup = document.getElementById('inspectionInputGroup');
                    const noteTextarea = document.getElementById('status_note');
                    const inspectionDate = document.getElementById('status_inspection_date');

                    // Hide all conditional groups first
                    noteGroup.style.display = 'none';
                    inspectionGroup.style.display = 'none';
                    noteTextarea.required = false;
                    inspectionDate.required = false;

                    if (['ยกเลิก', 'ไม่อนุมัติ'].includes(selectedStatus)) {
                        noteGroup.style.display = 'block';
                        noteTextarea.required = true;
                    } else if (['รอตรวจ', 'เลื่อนนัด'].includes(selectedStatus)) {
                        inspectionGroup.style.display = 'block';
                        inspectionDate.required = true;
                    } else if (selectedStatus === 'อนุมัติ') {
                        // For 'อนุมัติ', we redirect to the edit page.
                        // This logic is handled in the form submission.
                    }
                });

                // Handle form submission
                updateStatusForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newStatus = updateStatusSelect.value;
                    const rowIndex = document.getElementById('updateStatusRowIndex').value;

                    // Special case for 'อนุมัติ': redirect to edit page
                    if (newStatus === 'อนุมัติ') {
                        window.location.href = `/edit_customer_data/${rowIndex}`;
                        return;
                    }

                    const submitBtn = updateStatusForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'กำลังบันทึก...';

                    const formData = new FormData(updateStatusForm);
                    const data = Object.fromEntries(formData.entries());

                    // We will need a new, unified endpoint in app.py
                    // For now, let's assume it's '/update_customer_status'
                    try {
                        // This endpoint needs to be created in app.py
                        const response = await fetch('/update_customer_status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(data)
                        });
                        const result = await response.json();

                        if (response.ok && result.success) {
                            alert('อัปเดตสถานะเรียบร้อยแล้ว');
                            window.location.reload(); // Easiest way to reflect all changes
                        } else {
                            throw new Error(result.message || 'Failed to update status.');
                        }
                    } catch (error) {
                        console.error('Error updating status:', error);
                        alert('เกิดข้อผิดพลาด: ' + error.message);
                    } finally {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'ยืนยันการอัปเดต';
                        closeUpdateModal();
                    }
                });
            }

            // Lightbox Navigation and Close
            lightboxPrev.addEventListener('click', () => {
                currentImageIndex = (currentImageIndex - 1 + currentImageUrls.length) % currentImageUrls.length;
                currentZoom = 1;
                updateLightboxImage();
            });

            // Navigation and Close
            lightboxPrev.addEventListener('click', () => {
                currentImageIndex = (currentImageIndex - 1 + currentImageUrls.length) % currentImageUrls.length;
                currentZoom = 1; // Reset zoom on navigation
                updateLightboxImage();
            });

            lightboxNext.addEventListener('click', () => {
                currentImageIndex = (currentImageIndex + 1) % currentImageUrls.length;
                currentZoom = 1; // Reset zoom on navigation
                updateLightboxImage();
            });

            lightboxClose.addEventListener('click', closeLightbox);
            lightboxOverlay.addEventListener('click', (e) => {
                // Close if clicking on the overlay itself, not the image or controls
                if (e.target === lightboxOverlay) {
                    closeLightbox();
                }
            });

            // Zoom controls
            zoomInButton.addEventListener('click', () => {
                currentZoom = Math.min(currentZoom + 0.1, 3); // Max zoom 3x
                lightboxImage.style.transform = `scale(${currentZoom})`;
            });

            zoomOutButton.addEventListener('click', () => {
                currentZoom = Math.max(currentZoom - 0.1, 0.5); // Min zoom 0.5x
                lightboxImage.style.transform = `scale(${currentZoom})`;
            });

            // Keyboard navigation (optional)
            document.addEventListener('keydown', (e) => {
                if (lightboxOverlay.classList.contains('visible')) {
                    if (e.key === 'ArrowLeft') {
                        lightboxPrev.click();
                    } else if (e.key === 'ArrowRight') {
                        lightboxNext.click();
                    } else if (e.key === 'Escape') {
                        closeLightbox();
                    }
                }
            });
        });

        // --- NEW: Inspection Modal Logic ---
        const inspectionModal = document.getElementById('inspectionModal');
        if (inspectionModal) {
            const inspectionForm = document.getElementById('inspectionForm');
            const inspectionModalCloseBtn = document.getElementById('inspectionModalCloseBtn');

            // Close modal
            const closeInspectionModal = () => inspectionModal.classList.remove('visible');
            inspectionModalCloseBtn.addEventListener('click', closeInspectionModal);
            inspectionModal.addEventListener('click', (e) => {
                if (e.target === inspectionModal) {
                    closeInspectionModal();
                }
            });

            // Handle form submission
            inspectionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitBtn = inspectionForm.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.textContent = 'กำลังบันทึก...';

                const formData = new FormData(inspectionForm);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/schedule_inspection', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    const result = await response.json();

                    if (response.ok && result.success) {
                        alert('บันทึกการนัดหมายสำเร็จ');
                        closeInspectionModal();
                        // Reload page to show updated status and buttons
                        window.location.reload();
                    } else {
                        throw new Error(result.message || 'Failed to schedule inspection.');
                    }
                } catch (error) {
                    console.error('Error scheduling inspection:', error);
                    alert('เกิดข้อผิดพลาด: ' + error.message);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'บันทึกการนัดหมาย';
                }
            });
        }

        // --- Collapsible Sidebar Logic ---
        const sidebar = document.querySelector('.sidebar');
        const toggleButton = document.createElement('button');
        toggleButton.id = 'sidebar-toggle';
        toggleButton.className = 'sidebar-toggle-btn';
        toggleButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
        
        if (sidebar) {
            sidebar.appendChild(toggleButton);

            const toggleSidebar = () => {
                sidebar.classList.toggle('collapsed');
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
                updateToggleIcon(isCollapsed);
            };

            const updateToggleIcon = (isCollapsed) => {
                if (isCollapsed) {
                    toggleButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
                } else {
                    toggleButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
                }
            };

            toggleButton.addEventListener('click', toggleSidebar);

            // Check localStorage on page load
            const savedState = localStorage.getItem('sidebarCollapsed') === 'true';
            if (savedState) {
                sidebar.classList.add('collapsed');
            }
            updateToggleIcon(savedState);
        }
    </script>
</body>
</html>
